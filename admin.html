<script>
const API = 'https://pearlier-captivatingly-so.ngrok-free.dev';
const tabs = document.querySelectorAll('.tab');
const content = document.getElementById('content');
const status = document.getElementById('status');
const refreshBtn = document.createElement('button');
refreshBtn.textContent = 'Actualiser';
refreshBtn.style.cssText = 'padding:8px 12px;margin-bottom:12px;';
document.querySelector('.container').insertBefore(refreshBtn, content);

let dbData = { messages: [], attempts: [] };

async function loadData(){
  status.textContent = 'Chargement...';
  try {
    const res = await fetch(API+'/stats');
    if(!res.ok) throw new Error('Erreur réseau');
    const data = await res.json();
    dbData.messages = data.messages || [];
    dbData.attempts = data.attempts || [];
    status.textContent = '';
    renderTab('stats');
  } catch(err){
    console.error(err);
    status.textContent = 'Impossible de récupérer les données';
    content.innerHTML = '';
  }
}

function renderTab(tab){
  tabs.forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
  let html = '';

  if(tab==='stats'){
    html=`<div class="card">Messages: ${dbData.messages.length}<br>Tentatives: ${dbData.attempts.length}</div>`;
  } else if(tab==='messages'){
    html='<table><tr><th>Date</th><th>Nom</th><th>Email</th><th>Message</th></tr>';
    dbData.messages.forEach(m => {
      if(m.name||m.email||m.message)
        html+=`<tr><td>${new Date(m.date).toLocaleString()}</td><td>${m.name}</td><td>${m.email}</td><td>${m.message}</td></tr>`;
    });
    html+='</table>';
  } else if(tab==='attempts'){
    html='<table><tr><th>Date</th><th>Code tenté</th></tr>';
    dbData.attempts.forEach(a=>{
      html+=`<tr><td>${new Date(a.date).toLocaleString()}</td><td>${a.code}</td></tr>`;
    });
    html+='</table>';
  }
  content.innerHTML = html;
}

tabs.forEach(tab=>tab.addEventListener('click', ()=>renderTab(tab.dataset.tab)));
refreshBtn.addEventListener('click', loadData);

// Vérifie si admin connecté via index.html
if(sessionStorage.getItem('admin_logged')==='true'){
  loadData();
} else {
  window.location.href='index.html'; // pas d'accès direct via URL
}
</script>
